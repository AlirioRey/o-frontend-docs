# pega el contenido que ya te di# Handoff de AnÃ¡lisis
git add docs/agents/handoff/T-0002-db.md && git commit -m "docs: Winston handoff SQL para T-0002"

**Ruta sugerida:** docs/agents/handoff/T-0002-db.md

## Proposed_SQL
```sql
-- Consulta 1: SKUs de muestra (3 activos vendibles)
WITH skus AS (
  SELECT p.id AS sku_id, p.default_code
  FROM product_product p
  JOIN product_template t ON t.id = p.product_tmpl_id
  WHERE p.active = TRUE AND t.sale_ok = TRUE AND t.type = 'product'
  ORDER BY p.id ASC
  LIMIT 3
),
params AS (
  SELECT CURRENT_DATE - INTERVAL '7 days' AS from_date,
         CURRENT_DATE                 AS to_date
),
moves AS (
  SELECT m.product_id AS sku_id, DATE_TRUNC('day', m.date) AS d, SUM(m.product_uom_qty) AS qty
  FROM stock_move m
  JOIN stock_picking sp ON sp.id = m.picking_id
  JOIN stock_picking_type spt ON spt.id = sp.picking_type_id
  CROSS JOIN params
  WHERE m.state = 'done'
    AND spt.code = 'outgoing'
    AND m.date >= params.from_date
    AND m.date <  params.to_date
    AND m.product_id IN (SELECT sku_id FROM skus)
  GROUP BY m.product_id, DATE_TRUNC('day', m.date)
),
demanda_diaria AS (
  SELECT sku_id,
         GENERATE_SERIES((SELECT from_date FROM params)::date, (SELECT to_date FROM params)::date - 1, INTERVAL '1 day')::date AS d
  ) LEFT JOIN moves USING (sku_id,d)
),
aggr AS (
  SELECT sku_id,
         COALESCE(SUM(qty),0)                     AS demanda_7d,
         COALESCE(AVG(COALESCE(qty,0)),0)        AS demanda_diaria,
         COALESCE(STDDEV_POP(COALESCE(qty,0)),0) AS sigma_diaria
  FROM demanda_diaria
  GROUP BY sku_id
),
lead AS (
  SELECT pp.id AS sku_id, COALESCE(MIN(ps.delay),7) AS lead_time_d
  FROM product_product pp
  LEFT JOIN product_supplierinfo ps ON ps.product_tmpl_id = pp.product_tmpl_id
  WHERE pp.id IN (SELECT sku_id FROM skus)
  GROUP BY pp.id
)
SELECT a.sku_id,
       a.demanda_7d,
       a.demanda_diaria,
       a.sigma_diaria,
       l.lead_time_d,
       (1.65 * a.sigma_diaria * SQRT(l.lead_time_d))                                  AS safety_stock,
       (1.65 * a.sigma_diaria * SQRT(l.lead_time_d))                                  AS min,
       (1.65 * a.sigma_diaria * SQRT(l.lead_time_d)) + a.demanda_diaria * (l.lead_time_d + 3) AS max
FROM aggr a
JOIN lead l USING (sku_id)
ORDER BY a.sku_id;

